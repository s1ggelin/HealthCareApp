@page
@model AppointmentsModel

<h2>Book an Appointment</h2>

<form method="post" asp-page-handler="BookAppointment">
    <!-- Display available slots -->
    @foreach (var slot in Model.AvailableSlots)
    {
        <div class="card mb-3">
            <div class="card-body">
                <p>Caregiver ID: @slot.CaregiverId</p>
                <p>Date: @slot.Date.ToString("dd MMM yyyy")</p>
                <p>Time: @slot.Date.ToString("HH:mm")</p>

                <!-- Book Appointment Button -->
                <button type="button" class="btn btn-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#confirmModal"
                        data-caregiverid="@slot.CaregiverId"
                        data-slotdate="@slot.Date"
                        data-availabilityid="@slot.AvailabilityId">
                    Book Appointment
                </button>
            </div>
        </div>
    }

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalLabel">Confirm Booking</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to book this appointment?
                    <input type="hidden" id="hiddenCaregiverId" name="CaregiverId" />
                    <input type="hidden" id="hiddenSlotDate" name="SelectedSlot" />
                    <input type="hidden" id="hiddenPatientId" name="PatientId" />
                    <input type="hidden" id="hiddenAvailabilityId" name="AvailabilityId" /> <!-- Added hidden input for AvailabilityId -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Confirm</button>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
    var confirmModal = document.getElementById('confirmModal');
    confirmModal.addEventListener('show.bs.modal', function (event) {
        // Get the button that triggered the modal
        var button = event.relatedTarget;

        // Fetch the CaregiverId, SlotDate, and AvailabilityId from the button's data attributes
        var caregiverId = button.getAttribute('data-caregiverid');
        var slotDate = button.getAttribute('data-slotdate');
        var availabilityId = button.getAttribute('data-availabilityid');
        var patientId = localStorage.getItem('userId'); // Retrieve the patient ID from localStorage

        if (!caregiverId || !slotDate || !availabilityId) {
            console.error('CaregiverId, SlotDate, or AvailabilityId is missing in the button attributes');
            return;
        }

        // Update the hidden inputs in the modal
        document.getElementById('hiddenCaregiverId').value = caregiverId;
        document.getElementById('hiddenSlotDate').value = slotDate;
        document.getElementById('hiddenPatientId').value = patientId;
        document.getElementById('hiddenAvailabilityId').value = availabilityId; // Set the hidden AvailabilityId

        console.log('SlotDate:', slotDate);
        console.log('CaregiverId:', caregiverId);
        console.log('PatientId:', patientId);
        console.log('AvailabilityId:', availabilityId); // Log the AvailabilityId to verify
    });
</script>
